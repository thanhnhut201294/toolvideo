<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TikTok Batch Fetcher ‚Äî Worker</title>
  <style>
    :root{
      --bg:#f5f7fb;--card:#fff;--accent:#0b74ff;--muted:#6b7280;
      --ok:#16a34a;--err:#ef4444;
    }
    *{box-sizing:border-box}
    body{font-family:Inter,ui-sans-serif,system-ui,Arial,sans-serif;background:var(--bg);margin:0;padding:28px;display:flex;justify-content:center}
    .app{width:1200px;max-width:96%}
    header{display:flex;gap:12px;align-items:center;margin-bottom:12px}
    h1{font-size:18px;margin:0}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 8px 24px rgba(2,6,23,0.06)}
    textarea{width:100%;min-height:120px;padding:12px;border-radius:8px;border:1px solid #e6e9ef;font-size:14px;resize:vertical}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;align-items:center}
    .btn{padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-ghost{background:transparent;border:1px solid #dfe6f6;color:var(--accent)}
    .small{padding:8px 10px;font-size:13px}
    .muted{color:var(--muted);font-size:13px}
    .status{margin-left:auto;font-size:13px;color:var(--muted)}
    table{width:100%;border-collapse:collapse;margin-top:14px;font-size:13px}
    th,td{padding:10px;border-bottom:1px solid #f1f3f8;vertical-align:middle;text-align:left}
    th{background:#fbfdff;position:sticky;top:0}
    td.center{text-align:center}
    .cover{width:72px;height:72px;object-fit:cover;border-radius:8px}
    .truncate{max-width:300px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .tag-ok{color:var(--ok);font-weight:700}
    .tag-err{color:var(--err);font-weight:700}
    a.link{color:var(--accent);text-decoration:none}
    a.link:hover{text-decoration:underline}
    @media(max-width:980px){ .cover{width:56px;height:56px} .truncate{max-width:180px} }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>üé¨ TikTok Batch Fetcher (Worker)</h1>
        <div class="muted">Worker: <code>https://tikwmcom.thanhnhut201294.workers.dev</code></div>
      </div>
    </header>

    <div class="card">
      <label class="muted">D√°n danh s√°ch link TikTok (m·ªói link 1 d√≤ng):</label>
      <textarea id="inputUrls" placeholder="https://www.tiktok.com/@user/video/123...‚èéhttps://vt.tiktok.com/xxxx/"></textarea>

      <div class="controls">
        <button id="btnFetch" class="btn btn-primary">üîç L·∫•y th√¥ng tin</button>
        <button id="btnClear" class="btn btn-ghost">üßπ Xo√° b·∫£ng</button>
        <button id="btnSample" class="btn small">üì• D√°n m·∫´u</button>
        <button id="btnCsv" class="btn small">‚¨áÔ∏è T·∫£i CSV</button>
        <button id="btnXlsx" class="btn small">‚¨áÔ∏è T·∫£i XLSX</button>
        <div class="status" id="status">S·∫µn s√†ng</div>
      </div>

      <div style="margin-top:14px;overflow:auto;max-height:540px">
        <table id="resultTable">
          <thead>
            <tr>
              <th>STT</th>
              <th>·∫¢nh</th>
              <th>T√™n k√™nh</th>
              <th>Caption</th>
              <th>View</th>
              <th>Like</th>
              <th>Comment</th>
              <th>Save</th>
              <th>Share</th>
              <th>Link video</th>
              <th class="center">Tr·∫°ng th√°i</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <p class="muted" style="margin-top:10px">‚ö° Caption hi·ªÉn th·ªã r√∫t g·ªçn; file xu·∫•t ch·ª©a caption ƒë·∫ßy ƒë·ªß. M·ªói l·∫ßn qu√©t c√≥ delay 600ms ƒë·ªÉ tr√°nh gi·ªõi h·∫°n.</p>
    </div>
  </div>

  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script>
    const WORKER_BASE = 'https://tikwmcom.thanhnhut201294.workers.dev/?url=';
    const THROTTLE_MS = 600;

    const input = document.getElementById('inputUrls');
    const tbody = document.getElementById('tbody');
    const statusEl = document.getElementById('status');
    const btnCsv = document.getElementById('btnCsv');
    const btnXlsx = document.getElementById('btnXlsx');

    let dataStore = [];

    const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));
    const setStatus = (msg)=> statusEl.textContent = msg;
    const normalizeUrl = (u)=> { if(!u.startsWith('http')) return 'https://' + u.trim(); return u.trim(); };

    document.getElementById('btnSample').onclick = ()=>{
      input.value = 'https://www.tiktok.com/@hatothephuong261001/video/7551300167027281160\nhttps://www.tiktok.com/@nba/video/7423837056471182634';
    };
    document.getElementById('btnClear').onclick = ()=>{ tbody.innerHTML=''; dataStore=[]; setStatus('B·∫£ng tr·ªëng'); };

    document.getElementById('btnFetch').onclick = async ()=>{
      const urls = input.value.split(/\r?\n/).map(normalizeUrl).filter(Boolean);
      if(!urls.length) return alert('Vui l√≤ng nh·∫≠p √≠t nh·∫•t 1 link TikTok');
      tbody.innerHTML=''; dataStore=[]; setStatus(`ƒêang x·ª≠ l√Ω ${urls.length} link...`);

      urls.forEach((u,i)=>tbody.appendChild(makeRow(i+1,u)));

      for(let i=0;i<urls.length;i++){
        const url = urls[i];
        const row = tbody.children[i];
        const statusCell = row.querySelector('.status');
        statusCell.textContent='ƒêang...';

        try {
          const res = await fetch(WORKER_BASE+encodeURIComponent(url));
          const json = await res.json();
          let data = json.data ? json.data : json;

          if(!data || (!data.id && !data.title)){
            statusCell.textContent='L·ªói d·ªØ li·ªáu';
            statusCell.classList.add('tag-err');
            await sleep(THROTTLE_MS);
            continue;
          }

          // username l·∫•y t·ª´ URL (v√¨ TikWM ko lu√¥n tr·∫£)
          const userMatch = url.match(/tiktok\\.com\\/@([\\w\\.]+)/);
          const username = userMatch ? userMatch[1] : (data.author?.unique_id || '(Kh√¥ng r√µ)');

          const caption = data.title || data.caption || '(Kh√¥ng caption)';
          const shortCaption = caption.length>100?caption.slice(0,100)+'...':caption;
          const cover = data.cover || '';
          const stats = data.stats || {};
          const view = stats.play || data.play_count || 0;
          const like = stats.like || data.digg_count || 0;
          const comment = stats.comment || data.comment_count || 0;
          const save = stats.save || data.collect_count || 0;
          const share = stats.share || data.share_count || 0;

          const img=row.querySelector('.cover'); if(cover){img.src=cover;img.style.display='inline-block';}
          row.querySelector('.username').textContent=username;
          row.querySelector('.caption').textContent=shortCaption;
          row.querySelector('.view').textContent=view.toLocaleString();
          row.querySelector('.like').textContent=like.toLocaleString();
          row.querySelector('.comment').textContent=comment.toLocaleString();
          row.querySelector('.save').textContent=save.toLocaleString();
          row.querySelector('.share').textContent=share.toLocaleString();
          row.querySelector('.videoLink a').href=url;
          statusCell.textContent='OK'; statusCell.classList.add('tag-ok');

          dataStore.push({stt:i+1,username,caption,view,like,comment,save,share,url,cover});

        }catch(err){
          console.error(err);
          statusCell.textContent='L·ªói k·∫øt n·ªëi';
          statusCell.classList.add('tag-err');
        }

        await sleep(THROTTLE_MS);
        setStatus(`ƒê√£ x·ª≠ l√Ω ${i+1}/${urls.length}`);
      }
      setStatus('Ho√†n t·∫•t!');
    };

    function makeRow(i,url){
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${i}</td>
        <td class="center"><img src="" class="cover" style="display:none" width="70"></td>
        <td class="username">(ƒêang l·∫•y)</td>
        <td class="truncate caption">(ƒêang l·∫•y)</td>
        <td class="center view">‚Äî</td>
        <td class="center like">‚Äî</td>
        <td class="center comment">‚Äî</td>
        <td class="center save">‚Äî</td>
        <td class="center share">‚Äî</td>
        <td class="videoLink center"><a href="${url}" target="_blank" class="link">Xem</a></td>
        <td class="center status">Ch∆∞a</td>`;
      return tr;
    }

    btnCsv.onclick=()=>{
      if(!dataStore.length)return alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ t·∫£i!');
      const header=['STT','K√™nh','Caption','View','Like','Comment','Save','Share','Link','Cover'];
      const rows=[header.join(',')];
      dataStore.forEach(v=>{
        rows.push([
          v.stt,
          `"${v.username}"`,
          `"${v.caption.replace(/"/g,'""')}"`,
          v.view,v.like,v.comment,v.save,v.share,
          `"${v.url}"`,
          `"${v.cover}"`
        ].join(','));
      });
      const blob=new Blob([rows.join('\n')],{type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a');a.href=URL.createObjectURL(blob);
      a.download=`tiktok_stats_${new Date().toISOString().slice(0,10)}.csv`;a.click();
    };

    btnXlsx.onclick=()=>{
      if(!dataStore.length)return alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ t·∫£i!');
      const ws=XLSX.utils.json_to_sheet(dataStore.map(v=>({
        STT:v.stt,K√™nh:v.username,Caption:v.caption,View:v.view,Like:v.like,Comment:v.comment,Save:v.save,Share:v.share,Link:v.url,Cover:v.cover
      })));
      const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'TikTok');
      XLSX.writeFile(wb,`tiktok_stats_${new Date().toISOString().slice(0,10)}.xlsx`);
    };
  </script>
</body>
</html>
