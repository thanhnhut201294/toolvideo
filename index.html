<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TikWM Tool ‚Äî L·∫•y caption & stats</title>
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <style>
    :root{--bg:#f4f7fb;--card:#fff;--accent:#0066ff;--muted:#6b7280}
    *{box-sizing:border-box}
    body{font-family:Inter, system-ui, Arial, sans-serif;background:var(--bg);margin:0;padding:28px;display:flex;justify-content:center}
    .app{width:980px;max-width:96%;}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    p.lead{margin:0;color:var(--muted);font-size:13px}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(2,6,23,0.06);}

    textarea{width:100%;min-height:108px;padding:12px;border-radius:8px;border:1px solid #e6e9ef;font-size:14px}
    .row{display:flex;gap:10px;margin-top:12px}
    .col{flex:1}
    .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-ghost{background:transparent;border:1px solid #dfe6f6;color:var(--accent)}
    .small{font-size:13px;padding:8px 10px;border-radius:8px}
    .muted{color:var(--muted);font-size:13px}

    table{width:100%;border-collapse:collapse;margin-top:14px;font-size:13px}
    th,td{padding:8px 10px;border-bottom:1px solid #f0f2f7;text-align:left}
    th{background:#fbfdff;position:sticky;top:0}
    td.truncate{max-width:360px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .center{text-align:center}

    .controls{display:flex;gap:10px;align-items:center}
    .status{margin-left:auto;color:var(--muted);font-size:13px}
    .cover-img{width:64px;height:64px;object-fit:cover;border-radius:6px}

    @media(max-width:720px){.row{flex-direction:column}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>üé¨ TikWM Tool ‚Äî L·∫•y caption & stats</h1>
        <p class="lead">D√°n 1 link / 1 h√†ng (h·ªó tr·ª£ link ƒë·∫ßy ƒë·ªß & vt.tiktok.com). K·∫øt n·ªëi: <code>https://tikwmcom.thanhnhut201294.workers.dev</code></p>
      </div>
    </header>

    <div class="card">
      <label class="muted">Danh s√°ch link (m·ªói link 1 d√≤ng):</label>
      <textarea id="inputUrls" placeholder="https://www.tiktok.com/@user/video/123...\nhttps://vt.tiktok.com/xxxxx/"></textarea>

      <div class="row" style="margin-top:12px;align-items:center">
        <div class="col controls">
          <button id="btnFetch" class="btn btn-primary">L·∫•y th√¥ng tin</button>
          <button id="btnClear" class="btn btn-ghost">Xo√° b·∫£ng</button>
          <button id="btnCsv" class="btn small">T·∫£i CSV</button>
          <button id="btnXlsx" class="btn small">T·∫£i XLSX</button>
          <button id="btnSample" class="btn small">D√°n m·∫´u</button>
        </div>
        <div class="status" id="status">S·∫µn s√†ng</div>
      </div>

      <div id="tableWrap" style="margin-top:16px;overflow:auto;max-height:520px">
        <table id="resultTable">
          <thead>
            <tr>
              <th style="width:48px">STT</th>
              <th>URL</th>
              <th>·∫¢nh</th>
              <th>Caption</th>
              <th>View</th>
              <th>Like</th>
              <th>Comment</th>
              <th>Collect</th>
              <th>Share</th>
              <th class="center">Tr·∫°ng th√°i</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <p style="font-size:12px;color:var(--muted);margin-top:8px">Ghi ch√∫: caption hi·ªÉn th·ªã r√∫t g·ªçn tr√™n trang ƒë·ªÉ g·ªçn. File xu·∫•t s·∫Ω ch·ª©a caption ƒë·∫ßy ƒë·ªß.</p>
  </div>

  <!-- SheetJS cho xu·∫•t XLSX -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script>
    const WORKER_BASE = 'https://tikwmcom.thanhnhut201294.workers.dev/?url=';
    const tbody = document.getElementById('tbody');
    const statusEl = document.getElementById('status');
    const input = document.getElementById('inputUrls');

    function normalizeUrl(u){
      if(!u) return '';
      u = u.trim();
      if(!u) return '';
      if(!u.startsWith('http')) u = 'https://' + u;
      // n·∫øu l√† vm.tiktok ho·∫∑c r√∫t g·ªçn vt.tiktok -> gi·ªØ nguy√™n, Worker s·∫Ω encode
      return u;
    }

    function makeRow(i, url){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="center">${i}</td>
        <td><a href="${url}" target="_blank" rel="noopener">${url}</a></td>
        <td class="center"><img src="" class="cover-img" data-src="" alt=""></td>
        <td class="truncate"><span class="short"></span> <a href="#" class="more" style="margin-left:6px;display:none">show</a></td>
        <td class="center v-view">‚Äî</td>
        <td class="center v-like">‚Äî</td>
        <td class="center v-comment">‚Äî</td>
        <td class="center v-collect">‚Äî</td>
        <td class="center v-share">‚Äî</td>
        <td class="center status">Ch∆∞a x·ª≠ l√Ω</td>
      `;
      return tr;
    }

    function setStatus(msg){ statusEl.textContent = msg }

    document.getElementById('btnSample').addEventListener('click', ()=>{
      input.value = 'https://www.tiktok.com/@hatothephuong261001/video/7563558317218336008\nhttps://www.tiktok.com/@nba/video/7423837056471182634';
    });

    document.getElementById('btnClear').addEventListener('click', ()=>{
      tbody.innerHTML=''; setStatus('B·∫£ng ƒë√£ xo√°');
    });

    document.getElementById('btnFetch').addEventListener('click', async ()=>{
      const lines = input.value.split(/\n+/).map(l=>normalizeUrl(l)).filter(Boolean);
      if(lines.length===0){ alert('D√°n √≠t nh·∫•t 1 link TikTok (m·ªói link 1 d√≤ng).'); return }
      tbody.innerHTML = '';

      // t·∫°o h√†ng
      lines.forEach((url, idx)=> tbody.appendChild(makeRow(idx+1, url)) );

      setStatus('B·∫Øt ƒë·∫ßu l·∫•y d·ªØ li·ªáu...');

      for(let i=0;i<lines.length;i++){
        const row = tbody.children[i];
        const url = lines[i];
        const statusCell = row.querySelector('.status');
        statusCell.textContent = 'ƒêang...';

        try{
          // g·ªçi Worker
          const r = await fetch(WORKER_BASE + encodeURIComponent(url));
          const data = await r.json();

          if(data.error){
            statusCell.textContent = 'L·ªói';
            row.querySelector('.v-view').textContent = '-';
            row.querySelector('.v-like').textContent = '-';
            row.querySelector('.v-comment').textContent = '-';
            row.querySelector('.v-collect').textContent = '-';
            row.querySelector('.v-share').textContent = '-';
            console.warn('Worker error', data);
          } else {
            // fill
            const img = row.querySelector('.cover-img');
            if(data.cover) { img.src = data.cover; img.style.display='inline-block'; }
            row.querySelector('.v-view').textContent = (data.stats?.play ?? data.play ?? 0).toLocaleString();
            row.querySelector('.v-like').textContent = (data.stats?.like ?? data.like ?? data.digg_count ?? 0).toLocaleString();
            row.querySelector('.v-comment').textContent = (data.stats?.comment ?? data.comment ?? data.comment_count ?? 0).toLocaleString();
            row.querySelector('.v-collect').textContent = (data.stats?.collect ?? data.collect ?? data.collect_count ?? 0).toLocaleString();
            row.querySelector('.v-share').textContent = (data.stats?.share ?? data.share ?? data.share_count ?? 0).toLocaleString();

            // caption
            const fullCaption = (data.title || data.caption || '').toString();
            const shortEl = row.querySelector('.short');
            const more = row.querySelector('.more');
            const shortText = fullCaption.length>110 ? fullCaption.slice(0,110)+'...' : fullCaption;
            shortEl.textContent = shortText || '(Kh√¥ng caption)';
            more.style.display = fullCaption.length>110 ? 'inline' : 'none';
            more.addEventListener('click', e=>{ e.preventDefault(); if(more.textContent==='show'){ shortEl.textContent = fullCaption; more.textContent='hide' } else { shortEl.textContent = shortText; more.textContent='show' } });

            // store full caption on row for export
            row.dataset.fullCaption = fullCaption;
            statusCell.textContent = 'OK';
          }
        } catch(err){
          console.error(err);
          row.querySelector('.status').textContent = 'L·ªói k·∫øt n·ªëi';
        }

        // throttle ƒë·ªÉ tr√°nh rate limit
        await new Promise(r=>setTimeout(r, 600));
        setStatus(`ƒê√£ x·ª≠ l√Ω ${i+1}/${lines.length}`);
      }

      setStatus('Ho√†n t·∫•t');
    });

    // CSV export
    document.getElementById('btnCsv').addEventListener('click', ()=>{
      const rows = Array.from(tbody.children).map((tr, idx)=>{
        return {
          STT: idx+1,
          URL: tr.querySelector('td:nth-child(2) a')?.href || '',
          Caption: tr.dataset.fullCaption || tr.querySelector('.short')?.textContent || '',
          View: tr.querySelector('.v-view')?.textContent || '',
          Like: tr.querySelector('.v-like')?.textContent || '',
          Comment: tr.querySelector('.v-comment')?.textContent || '',
          Collect: tr.querySelector('.v-collect')?.textContent || '',
          Share: tr.querySelector('.v-share')?.textContent || ''
        }
      });
      if(rows.length===0){ alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ t·∫£i'); return }

      const header = Object.keys(rows[0]);
      const csv = [header.join(',')].concat(rows.map(r=> header.map(h=> '"'+String(r[h]||'').replace(/"/g,'""')+'"').join(','))).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `tiktok_stats_${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    // XLSX export via SheetJS
    document.getElementById('btnXlsx').addEventListener('click', ()=>{
      const data = Array.from(tbody.children).map((tr, idx)=>({
        STT: idx+1,
        URL: tr.querySelector('td:nth-child(2) a')?.href || '',
        Caption: tr.dataset.fullCaption || tr.querySelector('.short')?.textContent || '',
        View: tr.querySelector('.v-view')?.textContent || '',
        Like: tr.querySelector('.v-like')?.textContent || '',
        Comment: tr.querySelector('.v-comment')?.textContent || '',
        Collect: tr.querySelector('.v-collect')?.textContent || '',
        Share: tr.querySelector('.v-share')?.textContent || ''
      }));
      if(data.length===0){ alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ t·∫£i'); return }

      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'TikTok');
      const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
      const blob = new Blob([wbout], {type: 'application/octet-stream'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `tiktok_stats_${new Date().toISOString().slice(0,10)}.xlsx`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

  </script>
</body>
</html>
