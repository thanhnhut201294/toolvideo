<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TikTok Batch Fetcher ‚Äî Worker</title>
  <style>
    :root{
      --bg:#f5f7fb;--card:#fff;--accent:#0b74ff;--muted:#6b7280;
      --ok:#16a34a;--err:#ef4444;
    }
    *{box-sizing:border-box}
    body{font-family:Inter,ui-sans-serif,system-ui,Arial,sans-serif;background:var(--bg);margin:0;padding:28px;display:flex;justify-content:center}
    .app{width:1100px;max-width:96%}
    header{display:flex;gap:12px;align-items:center;margin-bottom:12px}
    h1{font-size:18px;margin:0}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 8px 24px rgba(2,6,23,0.06)}
    textarea{width:100%;min-height:120px;padding:12px;border-radius:8px;border:1px solid #e6e9ef;font-size:14px;resize:vertical}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;align-items:center}
    .btn{padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-ghost{background:transparent;border:1px solid #dfe6f6;color:var(--accent)}
    .small{padding:8px 10px;font-size:13px}
    .muted{color:var(--muted);font-size:13px}
    .status{margin-left:auto;font-size:13px;color:var(--muted)}
    table{width:100%;border-collapse:collapse;margin-top:14px;font-size:13px}
    th,td{padding:10px;border-bottom:1px solid #f1f3f8;vertical-align:middle;text-align:left}
    th{background:#fbfdff;position:sticky;top:0}
    td.center{text-align:center}
    .cover{width:72px;height:72px;object-fit:cover;border-radius:8px}
    .truncate{max-width:420px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .tag-ok{color:var(--ok);font-weight:700}
    .tag-err{color:var(--err);font-weight:700}
    @media(max-width:980px){ .cover{width:56px;height:56px} .truncate{max-width:200px} }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>üé¨ TikTok Batch Fetcher (Worker)</h1>
        <div class="muted">D√πng Worker: <code>https://tikwmcom.thanhnhut201294.workers.dev</code> ‚Äî d√°n 1 link / 1 d√≤ng</div>
      </div>
    </header>

    <div class="card">
      <label class="muted">Danh s√°ch link TikTok (m·ªói link 1 d√≤ng):</label>
      <textarea id="inputUrls" placeholder="https://www.tiktok.com/@user/video/123...‚èéhttps://vt.tiktok.com/xxxx/"></textarea>

      <div class="controls">
        <button id="btnFetch" class="btn btn-primary">üîç L·∫•y th√¥ng tin</button>
        <button id="btnClear" class="btn btn-ghost">üßπ Xo√° b·∫£ng</button>
        <button id="btnSample" class="btn small">üì• D√°n m·∫´u</button>
        <button id="btnCsv" class="btn small">‚¨áÔ∏è T·∫£i CSV</button>
        <button id="btnXlsx" class="btn small">‚¨áÔ∏è T·∫£i XLSX</button>
        <div class="status" id="status">S·∫µn s√†ng</div>
      </div>

      <div style="margin-top:14px;overflow:auto;max-height:540px">
        <table id="resultTable">
          <thead>
            <tr>
              <th style="width:48px">STT</th>
              <th style="width:96px">·∫¢nh</th>
              <th>Caption</th>
              <th style="width:110px">View</th>
              <th style="width:90px">Like</th>
              <th style="width:110px">Comment</th>
              <th style="width:90px">Save</th>
              <th style="width:90px">Share</th>
              <th style="width:90px" class="center">Tr·∫°ng th√°i</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <p class="muted" style="margin-top:10px">Ghi ch√∫: caption hi·ªÉn th·ªã r√∫t g·ªçn; file xu·∫•t s·∫Ω ch·ª©a caption ƒë·∫ßy ƒë·ªß. Throttle 600ms gi·ªØa c√°c request ƒë·ªÉ gi·∫£m kh·∫£ nƒÉng b·ªã rate-limit.</p>
    </div>
  </div>

  <!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <script>
    // ==== C·∫•u h√¨nh ====
    const WORKER_BASE = 'https://tikwmcom.thanhnhut201294.workers.dev/?url=';
    const THROTTLE_MS = 600;

    // ==== Elements ====
    const input = document.getElementById('inputUrls');
    const tbody = document.getElementById('tbody');
    const statusEl = document.getElementById('status');
    const btnFetch = document.getElementById('btnFetch');
    const btnClear = document.getElementById('btnClear');
    const btnSample = document.getElementById('btnSample');
    const btnCsv = document.getElementById('btnCsv');
    const btnXlsx = document.getElementById('btnXlsx');

    let dataStore = []; // l∆∞u k·∫øt qu·∫£ ƒë·∫ßy ƒë·ªß cho export

    function setStatus(msg){ statusEl.textContent = msg }

    function normalizeUrl(raw){
      if(!raw) return '';
      let u = raw.trim();
      if(!u) return '';
      // fix thi·∫øu scheme
      if(!/^https?:\/\//i.test(u)) u = 'https://' + u;
      // convert vm/vi shortcut? leave it - Worker handles encoding
      return u;
    }

    function makeRow(i, url){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="center">${i}</td>
        <td class="center"><img src="" class="cover" alt="cover" style="display:none"></td>
        <td class="truncate"><span class="short">(Ch∆∞a c√≥)</span> <a href="#" class="more" style="margin-left:6px;display:none">show</a></td>
        <td class="center v-view">‚Äî</td>
        <td class="center v-like">‚Äî</td>
        <td class="center v-comment">‚Äî</td>
        <td class="center v-save">‚Äî</td>
        <td class="center v-share">‚Äî</td>
        <td class="center status">Ch∆∞a</td>
      `;
      // store original url on row for later export
      tr.dataset.url = url;
      return tr;
    }

    btnSample.addEventListener('click', ()=> {
      input.value = 'https://www.tiktok.com/@hatothephuong261001/video/7551300167027281160\nhttps://www.tiktok.com/@nba/video/7423837056471182634';
    });

    btnClear.addEventListener('click', ()=> {
      tbody.innerHTML = ''; dataStore = []; setStatus('B·∫£ng ƒë√£ xo√°');
    });

    btnFetch.addEventListener('click', async ()=> {
      const lines = input.value.split(/\r?\n/).map(l=>normalizeUrl(l)).filter(Boolean);
      if(lines.length === 0){ alert('D√°n √≠t nh·∫•t 1 link TikTok (m·ªói link 1 d√≤ng).'); return; }

      tbody.innerHTML = ''; dataStore = [];
      setStatus(`B·∫Øt ƒë·∫ßu x·ª≠ l√Ω ${lines.length} video...`);

      // t·∫°o rows
      lines.forEach((u, idx)=> tbody.appendChild(makeRow(idx+1, u)) );

      for(let i=0;i<lines.length;i++){
        const url = lines[i];
        const row = tbody.children[i];
        const statusCell = row.querySelector('.status');
        statusCell.textContent = 'ƒêang...';
        setStatus(`X·ª≠ l√Ω ${i+1}/${lines.length}`);

        try {
          const apiUrl = WORKER_BASE + encodeURIComponent(url);
          const res = await fetch(apiUrl);
          // n·∫øu fetch th·∫•t b·∫°i do network/CORS, catch s·∫Ω x·ª≠ l√Ω
          const json = await res.json();

          // TikWM tr·∫£ c·∫•u tr√∫c: { code:0, data: { ... } } OR b·∫°n Worker c√≥ th·ªÉ tr·∫£ ch√≠nh data
          let data;
          if (json && json.code === 0 && json.data) {
            data = json.data;
          } else if (json && json.id && (json.stats || json.play)) {
            // worker ƒë√£ tr·∫£ object video tr·ª±c ti·∫øp (id, stats...)
            // normalize to same fields
            data = {
              id: json.id,
              title: json.title || json.caption || '',
              caption: json.caption || json.title || '',
              cover: json.cover || '',
              play_count: json.stats?.play ?? json.play ?? 0,
              digg_count: json.stats?.like ?? json.like ?? 0,
              comment_count: json.stats?.comment ?? json.comment ?? 0,
              collect_count: json.stats?.save ?? json.save ?? json.collect_count ?? 0,
              share_count: json.stats?.share ?? json.share ?? 0
            };
          } else {
            // l·ªói c·∫•u tr√∫c tr·∫£ v·ªÅ
            statusCell.textContent = 'L·ªói d·ªØ li·ªáu';
            statusCell.classList.add('tag-err');
            console.warn('Unexpected response', json);
            await sleep(THROTTLE_MS);
            continue;
          }

          // ƒëi·ªÅn d·ªØ li·ªáu v√†o row
          const img = row.querySelector('.cover');
          if (data.cover) { img.src = data.cover; img.style.display = 'inline-block'; } else img.style.display = 'none';

          const fullCaption = String(data.title || data.caption || '').trim();
          const shortText = fullCaption.length > 120 ? fullCaption.slice(0,120)+'...' : fullCaption || '(Kh√¥ng caption)';
          row.querySelector('.short').textContent = shortText;
          const moreBtn = row.querySelector('.more');
          if (fullCaption.length > 120) {
            moreBtn.style.display = 'inline';
            moreBtn.textContent = 'show';
            moreBtn.onclick = (e)=>{ e.preventDefault(); if(moreBtn.textContent==='show'){ row.querySelector('.short').textContent = fullCaption; moreBtn.textContent='hide' } else { row.querySelector('.short').textContent = shortText; moreBtn.textContent='show' } };
          } else moreBtn.style.display = 'none';

          row.querySelector('.v-view').textContent = Number(data.play_count || 0).toLocaleString();
          row.querySelector('.v-like').textContent = Number(data.digg_count || 0).toLocaleString();
          row.querySelector('.v-comment').textContent = Number(data.comment_count || 0).toLocaleString();
          row.querySelector('.v-save').textContent = Number(data.collect_count || 0).toLocaleString();
          row.querySelector('.v-share').textContent = Number(data.share_count || 0).toLocaleString();

          statusCell.textContent = 'OK';
          statusCell.classList.remove('tag-err');
          statusCell.classList.add('tag-ok');

          // l∆∞u v√†o dataStore cho export (l∆∞u full caption)
          dataStore.push({
            stt: i+1,
            url,
            id: data.id || '',
            caption: fullCaption,
            view: Number(data.play_count || 0),
            like: Number(data.digg_count || 0),
            comment: Number(data.comment_count || 0),
            save: Number(data.collect_count || 0),
            share: Number(data.share_count || 0),
            cover: data.cover || ''
          });

        } catch (err) {
          console.error('Fetch error', err);
          row.querySelector('.status').textContent = 'L·ªói k·∫øt n·ªëi';
          row.querySelector('.status').classList.add('tag-err');
        }

        // throttle
        await sleep(THROTTLE_MS);
      } // end for

      setStatus(`Ho√†n t·∫•t. ƒê√£ x·ª≠ l√Ω ${dataStore.length}/${lines.length} video.`);
    });

    // CSV export
    btnCsv.addEventListener('click', ()=> {
      if (!dataStore.length) return alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ t·∫£i.');
      const header = ['STT','URL','ID','Caption','View','Like','Comment','Save','Share','Cover'];
      const lines = [header.join(',')];
      dataStore.forEach(r=>{
        const row = [
          r.stt,
          `"${r.url.replace(/"/g,'""')}"`,
          `"${String(r.id).replace(/"/g,'""')}"`,
          `"${String(r.caption).replace(/"/g,'""')}"`,
          r.view, r.like, r.comment, r.save, r.share,
          `"${r.cover}"`
        ];
        lines.push(row.join(','));
      });
      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      a.download = `tiktok_stats_${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); a.remove();
    });

    // XLSX export via SheetJS
    btnXlsx.addEventListener('click', ()=> {
      if (!dataStore.length) return alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ t·∫£i.');
      const wsData = dataStore.map(r=>({
        STT: r.stt,
        URL: r.url,
        ID: r.id,
        Caption: r.caption,
        View: r.view,
        Like: r.like,
        Comment: r.comment,
        Save: r.save,
        Share: r.share,
        Cover: r.cover
      }));
      const ws = XLSX.utils.json_to_sheet(wsData);
      const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'TikTok');
      XLSX.writeFile(wb, `tiktok_stats_${new Date().toISOString().slice(0,10)}.xlsx`);
    });

    // small helper
    function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

    // initial status
    setStatus('S·∫µn s√†ng');
  </script>
</body>
</html>
